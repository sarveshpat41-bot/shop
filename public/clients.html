<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8fafc">
    <title>Client Management - Business Manager</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        /* Hamburger Menu Button (Mobile Only) */
        .hamburger-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .hamburger-btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .hamburger-btn i {
            font-size: 1.2rem;
            color: #1e293b;
            transition: transform 0.2s ease;
        }
        
        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .mobile-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: white;
            border-right: 1px solid #e2e8f0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            text-decoration: none;
        }
        
        .sidebar-brand i {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-item {
            margin: 2px 12px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #64748b;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            background: #f1f5f9;
            color: #1e293b;
        }
        
        .nav-link.active {
            background: #eff6ff;
            color: #3b82f6;
        }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }
        
        .top-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .dashboard-content {
            padding: 32px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .hamburger-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .top-header {
                padding: 16px 20px;
                padding-left: 70px;
            }
            
            .dashboard-content {
                padding: 20px 16px;
            }
            
            .page-title {
                font-size: 1.25rem;
            }
            
            .user-menu {
                padding: 6px 8px;
                gap: 8px;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            
            .user-menu div {
                display: none;
            }
            
            /* Mobile form optimizations */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .btn-create {
                padding: 10px 16px;
                font-size: 0.875rem;
            }
            
            .client-card {
                margin-bottom: 12px;
                padding: 16px;
            }
            
            .client-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .client-name {
                font-size: 1rem;
            }
            
            .row > div {
                margin-bottom: 12px;
            }
            
            .client-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 12px;
            }
            
            .lifetime-stats {
                padding: 10px;
            }
            
            .btn {
                font-size: 0.75rem;
                padding: 6px 12px;
            }
        }
        
        /* Prevent body scroll when mobile menu is open */
        body.mobile-menu-open {
            overflow: hidden;
        }
        
        /* Client specific styles */
        .client-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }
        
        .client-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .client-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.1rem;
        }
        
        .client-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .btn-create {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-create:hover {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .payment-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .payment-good {
            background: #10b981;
        }
        
        .payment-pending {
            background: #f59e0b;
        }
        
        .payment-overdue {
            background: #ef4444;
        }
        
        .client-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-right: 16px;
        }
        
        .lifetime-stats {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .stat-item:last-child {
            margin-bottom: 0;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button (Mobile Only) -->
    <button class="hamburger-btn" id="hamburgerMenu" aria-label="Toggle navigation">
        <i class="fas fa-bars" id="hamburgerIcon"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-brand">
                <i class="fas fa-business-time"></i>
                <span>Business Manager</span>
            </a>
        </div>
        
        <nav class="sidebar-nav" style="padding: 20px 0;" id="sidebarNav">
            <div class="nav-item">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="orders.html" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="editing.html" class="nav-link">
                    <i class="fas fa-video"></i>
                    <span>Editing Projects</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="transportation.html" class="nav-link">
                    <i class="fas fa-truck"></i>
                    <span>Transportation</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="salary.html" class="nav-link">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Salary Management</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="clients.html" class="nav-link active">
                    <i class="fas fa-users"></i>
                    <span>Clients</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="workers.html" class="nav-link">
                    <i class="fas fa-hard-hat"></i>
                    <span>Workers & Editors</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="calendar.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="page-title">Client Management</div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">A</div>
                <div>
                    <div style="font-weight: 600; font-size: 0.875rem;" id="userName">Loading...</div>
                    <div style="font-size: 0.75rem; color: #64748b;" id="userRole">Loading...</div>
                </div>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <main class="dashboard-content">
            <!-- Action Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Client Database</h3>
                <button class="btn-create" data-bs-toggle="modal" data-bs-target="#createClientModal">
                    <i class="fas fa-user-plus me-2"></i> Add Client
                </button>
            </div>
            
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="client-card text-center">
                        <h4 style="color: #10b981;" id="totalClients">12</h4>
                        <p class="mb-0" style="color: #64748b;">Total Clients</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="client-card text-center">
                        <h4 style="color: #3b82f6;" id="activeClients">8</h4>
                        <p class="mb-0" style="color: #64748b;">Active Clients</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="client-card text-center">
                        <h4 style="color: #f59e0b;" id="totalRevenue">₹5,50,000</h4>
                        <p class="mb-0" style="color: #64748b;">Total Revenue</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="client-card text-center">
                        <h4 style="color: #ef4444;" id="pendingPayments">₹75,000</h4>
                        <p class="mb-0" style="color: #64748b;">Pending Payments</p>
                    </div>
                </div>
            </div>
            
            <!-- Clients List -->
            <div class="row">
                <div class="col-12">
                    <h4 class="mb-3">Client Directory</h4>
                    <div id="clientsList">
                        <!-- Clients will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Create Client Modal -->
    <div class="modal fade" id="createClientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createClientForm">
                        <div class="mb-3">
                            <label class="form-label">Client Name *</label>
                            <input type="text" class="form-control" id="clientName" placeholder="Full name or company name" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="clientEmail" placeholder="client@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="+91 9876543210" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="clientNotes" rows="2" placeholder="Additional notes about the client..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="createClient()">Add Client</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadClients();
        });
        
        // Check authentication and setup role-based access
        function checkAuth() {
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userData);
                updateUserInfo(user);
                setupRoleBasedAccess(user);
            } catch (error) {
                window.location.href = 'login.html';
            }
        }
        
        // Setup role-based access control
        function setupRoleBasedAccess(user) {
            const userRole = user.role.toLowerCase();
            
            if (userRole !== 'owner') {
                // Redirect non-owners to dashboard
                showAlert('Access Denied: Only owners can access client management.', 'danger');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
        }
        
        // Show alert function
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '9999';
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }
        
        // Update user info
        function updateUserInfo(user) {
            const userName = `${user.firstName} ${user.lastName}`;
            const userInitials = `${user.firstName.charAt(0)}${user.lastName.charAt(0)}`.toUpperCase();
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
            document.getElementById('userAvatar').textContent = userInitials;
        }
        
        // Load clients
        async function loadClients() {
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = '<div class="text-center p-4">Loading clients...</div>';
            
            const userData = JSON.parse(localStorage.getItem('user'));
            
            try {
                // Build query parameters for shop-based filtering
                // Handle both 'id' and '_id' fields for compatibility
                const userId = userData._id || userData.id;
                
                const params = new URLSearchParams({
                    shopName: userData.shopName,
                    userRole: userData.role.toLowerCase(),
                    userId: userId
                });
                
                console.log('Loading clients with params:', {
                    shopName: userData.shopName,
                    userRole: userData.role.toLowerCase(),
                    userId: userId
                });
                
                const response = await fetch(`https://manageroffice.onrender.com/api/clients?${params}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch clients');
                }
                
                const data = await response.json();
                const clients = data.data || [];
                
                console.log('Clients received:', clients.length);
                
                clientsList.innerHTML = '';
                
                if (clients.length === 0) {
                    clientsList.innerHTML = `
                        <div class="text-center p-4" style="color: #64748b;">
                            <i class="fas fa-users fa-3x mb-3" style="opacity: 0.3;"></i>
                            <h5>No clients found</h5>
                            <p>There are no clients in the system at the moment.</p>
                        </div>
                    `;
                    return;
                }
                
                // Update stats based on loaded data
                updateClientStats(clients);
                
                clients.forEach(client => {
                    const clientCard = createClientCard(client);
                    clientsList.appendChild(clientCard);
                });
                
            } catch (error) {
                console.error('Error loading clients:', error);
                clientsList.innerHTML = `
                    <div class="text-center p-4" style="color: #ef4444;">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>Error Loading Clients</h5>
                        <p>Unable to load clients from the database. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadClients()">Retry</button>
                    </div>
                `;
            }
        }
        
        // Update client statistics
        function updateClientStats(clients) {
            const totalClients = clients.length;
            const activeClients = clients.filter(c => c.paymentStatus !== 'inactive').length;
            const totalRevenue = clients.reduce((sum, c) => sum + (c.totalPaymentsDue || 0), 0);
            const pendingPayments = clients.reduce((sum, c) => sum + (c.pendingPayments || 0), 0);
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('activeClients').textContent = activeClients;
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
            document.getElementById('pendingPayments').textContent = `₹${pendingPayments.toLocaleString()}`;
        }
        
        // Create client card
        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'client-card';
            
            const status = client.paymentStatus || (client.pendingPayments > 0 ? 'pending' : 'paid');
            const statusClass = `status-${status}`;
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Payment indicator
            let paymentClass = 'payment-good';
            const pendingAmount = client.pendingPayments || 0;
            const totalDue = client.totalPaymentsDue || 0;
            const receivedAmount = totalDue - pendingAmount;
            
            if (pendingAmount > 0) {
                paymentClass = pendingAmount > 50000 ? 'payment-overdue' : 'payment-pending';
            }
            
            // Client initials for avatar
            const initials = client.name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
            
            // Calculate lifetime statistics
            const lifetimeOrders = client.lifetimeOrders || 0;
            const lifetimeProjects = client.lifetimeEditingProjects || 0;
            const lifetimeValue = client.lifetimeValue || (client.totalPaymentsDue || 0);
            const lastOrderDate = client.orderHistory && client.orderHistory.length > 0 ? 
                client.orderHistory[client.orderHistory.length - 1].date : 
                client.createdAt;
            
            // Use actual client data (removed clientType, priority, businessCategory)
            
            // Check if user is owner to show edit button
            const userData = JSON.parse(localStorage.getItem('user'));
            const isOwner = userData && userData.role && userData.role.toLowerCase() === 'owner';
            
            // Create edit payment button for owners only
            let editPaymentButton = '';
            if (isOwner) {
                editPaymentButton = `
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="editClientPayment('${client._id}', '${client.name}', ${totalDue}, ${receivedAmount})">
                            <i class="fas fa-edit me-2"></i>Update Payment Info
                        </button>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="client-header">
                    <div style="display: flex; align-items: center;">
                        <div class="client-avatar">${initials}</div>
                        <div>
                            <div class="client-name">${client.name}</div>
                            <div style="color: #64748b; font-size: 0.875rem;">
                                <i class="fas fa-user me-1"></i>Client
                            </div>
                        </div>
                    </div>
                    <div class="client-status ${statusClass}">${statusText}</div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <strong>Contact:</strong><br>
                        <span style="color: #64748b; font-size: 0.875rem;">
                            <i class="fas fa-phone me-1"></i>${client.phone}<br>
                            <i class="fas fa-envelope me-1"></i>${client.email || 'No email'}
                        </span>
                    </div>
                    <div class="col-md-4">
                        <strong>Last Activity:</strong><br>
                        <span style="color: #64748b;">${lastOrderDate ? new Date(lastOrderDate).toLocaleDateString() : 'No activity'}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Payment Status:</strong><br>
                        <span style="color: #64748b;">
                            <span class="payment-indicator ${paymentClass}"></span>
                            ${pendingAmount > 0 ? `₹${pendingAmount.toLocaleString()} pending` : 'All clear'}
                        </span>
                    </div>
                </div>
                
                <div class="lifetime-stats">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                        <i class="fas fa-chart-line me-2"></i>Lifetime Statistics
                    </div>
                    <div class="stat-item">
                        <span><i class="fas fa-box me-2" style="color: #3b82f6;"></i>Total Orders:</span>
                        <span style="font-weight: 600;">${lifetimeOrders}</span>
                    </div>
                    <div class="stat-item">
                        <span><i class="fas fa-video me-2" style="color: #8b5cf6;"></i>Total Projects:</span>
                        <span style="font-weight: 600;">${lifetimeProjects}</span>
                    </div>
                    <div style="margin: 12px 0; border-top: 1px solid #e2e8f0;"></div>
                    <div style="font-weight: 600; margin-bottom: 8px; color: #1e293b;">
                        <i class="fas fa-rupee-sign me-2"></i>Payment Information
                    </div>
                    <div class="stat-item">
                        <span>Total Amount:</span>
                        <span style="font-weight: 600; color: #3b82f6;">₹${lifetimeValue.toLocaleString()}</span>
                    </div>
                    <div class="stat-item">
                        <span>Received:</span>
                        <span style="font-weight: 600; color: #10b981;">₹${receivedAmount.toLocaleString()}</span>
                    </div>
                    <div class="stat-item" style="padding-top: 8px; border-top: 1px dashed #e2e8f0; margin-top: 4px;">
                        <span style="font-weight: 600;">Pending:</span>
                        <span style="font-weight: 700; font-size: 1.1rem; color: ${pendingAmount > 0 ? '#ef4444' : '#10b981'};">₹${pendingAmount.toLocaleString()}</span>
                    </div>
                    ${pendingAmount > 0 ? `
                    <div class="mt-2 p-2" style="background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                        <small style="color: #991b1b;">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            Payment pending from client
                        </small>
                    </div>
                    ` : `
                    <div class="mt-2 p-2" style="background: #f0fdf4; border-left: 3px solid #10b981; border-radius: 4px;">
                        <small style="color: #166534;">
                            <i class="fas fa-check-circle me-1"></i>
                            All payments cleared
                        </small>
                    </div>
                    `}
                </div>
                
                ${editPaymentButton}
                
                ${client.address ? `
                <div class="mt-2">
                    <strong>Address:</strong><br>
                    <span style="color: #64748b; font-size: 0.875rem;">${client.address}</span>
                </div>
                ` : ''}
                
                ${client.notes ? `
                <div class="mt-2">
                    <strong>Notes:</strong><br>
                    <span style="color: #64748b; font-size: 0.875rem;">${client.notes}</span>
                </div>
                ` : ''}
            `;
            
            return card;
        }
        
        // Create client
        async function createClient() {
            const form = document.getElementById('createClientForm');
            
            // Basic validation
            const clientName = document.getElementById('clientName').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientEmail = document.getElementById('clientEmail').value.trim();
            
            if (!clientName || !clientPhone) {
                showAlert('Please fill in all required fields (Name and Phone)', 'warning');
                return;
            }
            
            // Email validation if provided
            if (clientEmail && !isValidEmail(clientEmail)) {
                showAlert('Please enter a valid email address', 'warning');
                return;
            }
            
            try {
                const userData = JSON.parse(localStorage.getItem('user'));
                if (!userData) {
                    throw new Error('No user data found');
                }
                
                // Create new client object for API
                const newClient = {
                    name: clientName,
                    email: clientEmail || '', // Allow empty email
                    phone: clientPhone,
                    address: '', // Empty address (field removed from form)
                    shopName: userData.shopName, // Associate client with current user's shop
                    notes: document.getElementById('clientNotes').value.trim()
                };
                
                console.log('Creating client:', newClient);
                
                // Send to API
                const response = await fetch('https://manageroffice.onrender.com/api/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newClient)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to create client');
                }
                
                const result = await response.json();
                console.log('Client created successfully:', result);
                
                // Reload clients list
                await loadClients();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createClientModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                
                showAlert('Client added successfully!', 'success');
                
            } catch (error) {
                console.error('Error creating client:', error);
                showAlert(`Failed to create client: ${error.message}`, 'danger');
            }
        }
        
        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Edit client payment function
        async function editClientPayment(clientId, clientName, totalDue, currentReceived) {
            try {
                // Fetch client orders and projects
                const userData = JSON.parse(localStorage.getItem('user'));
                const params = new URLSearchParams({
                    shopName: userData.shopName,
                    userRole: 'owner',
                    userId: userData._id || userData.id
                });
                
                // Fetch orders
                const ordersResponse = await fetch(`https://manageroffice.onrender.com/api/orders?${params}`);
                const ordersData = await ordersResponse.json();
                
                // Fetch editing projects
                const projectsResponse = await fetch(`https://manageroffice.onrender.com/api/editing?${params}`);
                const projectsData = await projectsResponse.json();
                
                // Filter orders for this client
                const clientOrders = ordersData.data.filter(order => {
                    if (order.client && typeof order.client === 'object') {
                        return order.client._id === clientId;
                    }
                    return order.client === clientId;
                });
                
                // Filter projects for this client
                const clientProjects = projectsData.data.filter(project => {
                    if (project.client && typeof project.client === 'object') {
                        return project.client._id === clientId;
                    }
                    return project.client === clientId;
                });
                
                console.log('Client orders:', clientOrders);
                console.log('Client projects:', clientProjects);
                
                // Create orders HTML
                let ordersHTML = '';
                if (clientOrders && clientOrders.length > 0) {
                    ordersHTML = clientOrders.map(order => {
                        const orderDate = new Date(order.orderDate || order.createdAt).toLocaleDateString();
                        const statusClass = order.status === 'completed' ? 'success' : order.status === 'in_progress' ? 'warning' : 'secondary';
                        const paymentPercent = order.totalAmount > 0 ? Math.round((order.receivedPayment / order.totalAmount) * 100) : 0;
                        
                        // Products list
                        let productsHTML = '';
                        if (order.products && order.products.length > 0) {
                            productsHTML = order.products.map(product => {
                                const quantityDisplay = product.sizeInfo || `Qty: ${product.quantity}`;
                                const lineTotal = product.price * product.quantity;
                                return `
                                    <tr style="font-size: 0.85rem;">
                                        <td style="padding: 4px 8px;">${product.name}</td>
                                        <td style="padding: 4px 8px; text-align: center;">${quantityDisplay}</td>
                                        <td style="padding: 4px 8px; text-align: right;">₹${product.price.toLocaleString()}</td>
                                        <td style="padding: 4px 8px; text-align: right;">₹${lineTotal.toLocaleString()}</td>
                                    </tr>
                                `;
                            }).join('');
                        }
                        
                        return `
                            <div class="order-item mb-3 p-3" style="border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge bg-primary me-2">ORDER</span>
                                        <strong style="color: #1e293b;">${order.orderName || 'Order'}</strong>
                                        <div class="text-muted small">
                                            <i class="fas fa-calendar me-1"></i>${orderDate}
                                            <span class="badge bg-${statusClass} ms-2">${order.status.replace('_', ' ').toUpperCase()}</span>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-map-marker-alt me-1"></i>${order.venuePlace || 'No venue'}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success" onclick="generateReceipt('${order._id}', '${clientName}')">
                                        <i class="fas fa-receipt me-1"></i>Receipt
                                    </button>
                                </div>
                                
                                <!-- Products Table -->
                                ${productsHTML ? `
                                <div class="mb-2">
                                    <table class="table table-sm mb-0" style="font-size: 0.875rem;">
                                        <thead style="background: #f8fafc;">
                                            <tr>
                                                <th style="border: none; padding: 6px 8px;">Product</th>
                                                <th style="border: none; padding: 6px 8px; text-align: center;">Qty/Size</th>
                                                <th style="border: none; padding: 6px 8px; text-align: right;">Unit Price</th>
                                                <th style="border: none; padding: 6px 8px; text-align: right;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${productsHTML}
                                        </tbody>
                                    </table>
                                </div>
                                ` : ''}
                                
                                <!-- Payment Info -->
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <small class="text-muted">Total Amount:</small><br>
                                        <strong style="color: #3b82f6;">₹${order.totalAmount.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Received:</small><br>
                                        <strong style="color: #10b981;">₹${order.receivedPayment.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Pending:</small><br>
                                        <strong style="color: ${order.remainingPayment > 0 ? '#ef4444' : '#10b981'};">₹${order.remainingPayment.toLocaleString()}</strong>
                                    </div>
                                </div>
                                
                                <!-- Payment Progress Bar -->
                                <div class="mt-2">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${paymentPercent}%" 
                                             aria-valuenow="${paymentPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">${paymentPercent}% paid</small>
                                </div>
                                
                                <!-- Update Payment -->
                                <div class="mt-3">
                                    <div class="row align-items-end mb-2">
                                        <div class="col-md-3">
                                            <label class="form-label small">Payment Amount *</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">₹</span>
                                                <input type="number" class="form-control" id="payment_amount_${order._id}" 
                                                       placeholder="Enter amount" min="0" max="${order.remainingPayment}" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">Payment Date *</label>
                                            <input type="date" class="form-control form-control-sm" id="payment_date_${order._id}" 
                                                   value="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">Method *</label>
                                            <select class="form-select form-select-sm" id="payment_method_${order._id}">
                                                <option value="cash">Cash</option>
                                                <option value="bank_transfer">Bank Transfer</option>
                                                <option value="upi">UPI</option>
                                                <option value="cheque">Cheque</option>
                                                <option value="card">Card</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Received By *</label>
                                            <select class="form-select form-select-sm" id="payment_receiver_${order._id}">
                                                <option value="">Loading...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary btn-sm w-100" 
                                                    onclick="addPaymentRecord('${order._id}', '${clientId}', ${order.totalAmount})">
                                                <i class="fas fa-plus me-1"></i>Add Payment
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control form-control-sm" id="payment_notes_${order._id}" 
                                                   placeholder="Payment notes (optional)">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment History -->
                                <div class="mt-3" id="payment_history_${order._id}">
                                    <small class="text-muted">Loading payment history...</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Load workers/editors/transporters for "Received By" dropdowns after modal is shown
                    setTimeout(() => {
                        loadPaymentReceivers();
                        clientOrders.forEach(order => {
                            loadPaymentHistory(order._id);
                        });
                        clientProjects.forEach(project => {
                            loadPaymentHistory(project._id);
                        });
                    }, 100);
                } else {
                    ordersHTML = '';
                }
                
                // Create projects HTML
                let projectsHTML = '';
                if (clientProjects && clientProjects.length > 0) {
                    projectsHTML = clientProjects.map(project => {
                        const projectDate = new Date(project.startDate || project.createdAt).toLocaleDateString();
                        const endDate = new Date(project.endDate).toLocaleDateString();
                        const statusClass = project.status === 'completed' ? 'success' : project.status === 'in_progress' ? 'warning' : 'secondary';
                        const paymentPercent = project.totalAmount > 0 ? Math.round((project.receivedPayment / project.totalAmount) * 100) : 0;
                        const editorName = project.editor ? `${project.editor.firstName} ${project.editor.lastName}` : 'Unknown';
                        
                        // Project details table
                        let detailsHTML = `
                            <table class="table table-sm mb-0" style="font-size: 0.875rem;">
                                <tbody>
                                    <tr style="font-size: 0.85rem;">
                                        <td style="padding: 4px 8px; width: 30%;"><strong>Editing Value:</strong></td>
                                        <td style="padding: 4px 8px; text-align: right;">₹${(project.editingValue || 0).toLocaleString()}</td>
                                    </tr>
                                    ${project.pendriveIncluded ? `
                                    <tr style="font-size: 0.85rem;">
                                        <td style="padding: 4px 8px;"><strong>Pendrive:</strong></td>
                                        <td style="padding: 4px 8px; text-align: right;">₹${(project.pendriveValue || 0).toLocaleString()}</td>
                                    </tr>
                                    ` : ''}
                                    <tr style="font-size: 0.85rem; background: #f8fafc;">
                                        <td style="padding: 4px 8px;"><strong>Total:</strong></td>
                                        <td style="padding: 4px 8px; text-align: right;"><strong>₹${project.totalAmount.toLocaleString()}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                        
                        return `
                            <div class="order-item mb-3 p-3" style="border: 1px solid #8b5cf6; border-radius: 8px; background: white;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge bg-purple me-2" style="background: #8b5cf6;">PROJECT</span>
                                        <strong style="color: #1e293b;">${project.projectName || 'Editing Project'}</strong>
                                        <div class="text-muted small">
                                            <i class="fas fa-calendar me-1"></i>${projectDate} - ${endDate}
                                            <span class="badge bg-${statusClass} ms-2">${project.status.replace('_', ' ').toUpperCase()}</span>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-user-edit me-1"></i>Editor: ${editorName}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Project Details -->
                                <div class="mb-2">
                                    ${detailsHTML}
                                </div>
                                
                                <!-- Payment Info -->
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <small class="text-muted">Total Amount:</small><br>
                                        <strong style="color: #3b82f6;">₹${project.totalAmount.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Received:</small><br>
                                        <strong style="color: #10b981;">₹${project.receivedPayment.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Pending:</small><br>
                                        <strong style="color: ${project.remainingPayment > 0 ? '#ef4444' : '#10b981'};">₹${project.remainingPayment.toLocaleString()}</strong>
                                    </div>
                                </div>
                                
                                <!-- Payment Progress Bar -->
                                <div class="mt-2">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${paymentPercent}%" 
                                             aria-valuenow="${paymentPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">${paymentPercent}% paid</small>
                                </div>
                                
                                <!-- Update Payment -->
                                <div class="mt-3">
                                    <div class="row align-items-end mb-2">
                                        <div class="col-md-3">
                                            <label class="form-label small">Payment Amount *</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">₹</span>
                                                <input type="number" class="form-control" id="payment_amount_${project._id}" 
                                                       placeholder="Enter amount" min="0" max="${project.remainingPayment}" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">Payment Date *</label>
                                            <input type="date" class="form-control form-control-sm" id="payment_date_${project._id}" 
                                                   value="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">Method *</label>
                                            <select class="form-select form-select-sm" id="payment_method_${project._id}">
                                                <option value="cash">Cash</option>
                                                <option value="bank_transfer">Bank Transfer</option>
                                                <option value="upi">UPI</option>
                                                <option value="cheque">Cheque</option>
                                                <option value="card">Card</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Received By *</label>
                                            <select class="form-select form-select-sm" id="payment_receiver_${project._id}">
                                                <option value="">Loading...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary btn-sm w-100" 
                                                    onclick="addPaymentRecord('${project._id}', '${clientId}', ${project.totalAmount})">
                                                <i class="fas fa-plus me-1"></i>Add Payment
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control form-control-sm" id="payment_notes_${project._id}" 
                                                   placeholder="Payment notes (optional)">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment History -->
                                <div class="mt-3" id="payment_history_${project._id}">
                                    <small class="text-muted">Loading payment history...</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    projectsHTML = '';
                }
                
                // Combine orders and projects
                const allItemsHTML = ordersHTML + projectsHTML;
                
                const finalHTML = allItemsHTML || `
                    <div class="text-center p-4" style="color: #64748b;">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No orders or projects found for this client.</p>
                    </div>
                `;
                
                const modalHTML = `
                    <div class="modal fade" id="editPaymentModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Payment Management - ${clientName}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Payment Summary -->
                                    <div class="mb-4 p-3" style="background: #f8fafc; border-radius: 8px;">
                                        <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Payment Summary</h6>
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <div class="h4 mb-1" style="color: #3b82f6;">₹${totalDue.toLocaleString()}</div>
                                                <small class="text-muted">Total Amount</small>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <div class="h4 mb-1" style="color: #10b981;">₹${currentReceived.toLocaleString()}</div>
                                                <small class="text-muted">Received</small>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <div class="h4 mb-1" style="color: #ef4444;">₹${(totalDue - currentReceived).toLocaleString()}</div>
                                                <small class="text-muted">Pending</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Orders & Projects List -->
                                    <div class="mb-3">
                                        <h6><i class="fas fa-list me-2"></i>Orders & Projects</h6>
                                        <div style="max-height: 500px; overflow-y: auto;">
                                            ${finalHTML}
                                        </div>
                                    </div>
                                    
                                    <div id="paymentUpdateResult"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('editPaymentModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading client orders:', error);
                showAlert('Error loading client orders', 'danger');
            }
        }
        
        // Update order payment
        async function updateOrderPayment(orderId, totalAmount) {
            const receivedAmount = parseFloat(document.getElementById(`payment_${orderId}`).value) || 0;
            
            if (receivedAmount < 0) {
                showAlert('Amount cannot be negative', 'warning');
                return;
            }
            
            if (receivedAmount > totalAmount) {
                showAlert('Received amount cannot exceed total amount', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`https://manageroffice.onrender.com/api/orders/${orderId}/payment`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ receivedPayment: receivedAmount })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Payment updated successfully!', 'success');
                    // Refresh the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentModal'));
                    modal.hide();
                    loadClients();
                } else {
                    showAlert(`Error: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                showAlert('Network error while updating payment', 'danger');
            }
        }
        
        // Load payment receivers (workers, editors, transporters, owners)
        async function loadPaymentReceivers() {
            try {
                const userData = JSON.parse(localStorage.getItem('user'));
                const params = new URLSearchParams({
                    shopName: userData.shopName,
                    userRole: 'owner', // Request as owner to get all users including owners
                    userId: userData._id || userData.id
                });
                
                const response = await fetch(`https://manageroffice.onrender.com/api/users?${params}`);
                const data = await response.json();
                
                console.log('Users API response:', data);
                
                if (response.ok && data.data) {
                    // Filter for workers, editors, transporters, and owners
                    const receivers = data.data.filter(user => {
                        const role = user.role.toLowerCase();
                        return role.includes('worker') || 
                               role.includes('editor') || 
                               role.includes('transporter') ||
                               role === 'owner';
                    });
                    
                    console.log('Payment receivers loaded:', receivers.length);
                    console.log('Receivers:', receivers.map(r => `${r.firstName} ${r.lastName} (${r.role})`));
                    
                    // Update all receiver dropdowns
                    document.querySelectorAll('[id^="payment_receiver_"]').forEach(select => {
                        select.innerHTML = '<option value="">Select Person</option>' + 
                            receivers.map(receiver => {
                                const displayRole = receiver.role.charAt(0).toUpperCase() + receiver.role.slice(1);
                                return `<option value="${receiver._id}">${receiver.firstName} ${receiver.lastName} (${displayRole})</option>`;
                            }).join('');
                        
                        // Set current user as default
                        const currentUserId = userData._id || userData.id;
                        if (currentUserId) {
                            select.value = currentUserId;
                        }
                    });
                    
                    console.log('Payment receiver dropdowns updated');
                } else {
                    console.error('Failed to load users:', data);
                }
            } catch (error) {
                console.error('Error loading payment receivers:', error);
            }
        }
        
        // Load payment history for an order
        async function loadPaymentHistory(orderId) {
            try {
                const response = await fetch(`https://manageroffice.onrender.com/api/payments/order/${orderId}`);
                const data = await response.json();
                
                const historyDiv = document.getElementById(`payment_history_${orderId}`);
                
                if (response.ok && data.data && data.data.length > 0) {
                    const paymentsHTML = data.data.map(payment => {
                        const paymentDate = new Date(payment.paymentDate).toLocaleDateString();
                        const paymentTime = new Date(payment.paymentDate).toLocaleTimeString();
                        const receiverName = payment.receivedBy ? 
                            `${payment.receivedBy.firstName} ${payment.receivedBy.lastName}` : 
                            'Unknown';
                        const receiverRole = payment.receivedBy ? 
                            payment.receivedBy.role.charAt(0).toUpperCase() + payment.receivedBy.role.slice(1) : 
                            '';
                        const paymentMethod = payment.paymentMethod || 'cash';
                        
                        return `
                            <div class="p-2 mb-2" style="background: #f8fafc; border-left: 3px solid #10b981; border-radius: 4px;">
                                <div class="row align-items-center" style="font-size: 0.875rem;">
                                    <div class="col-md-3">
                                        <strong style="color: #10b981; font-size: 1rem;">₹${payment.amount.toLocaleString()}</strong>
                                        <div class="text-muted small"><i class="fas fa-calendar me-1"></i>${paymentDate}</div>
                                        <div class="text-muted small"><i class="fas fa-clock me-1"></i>${paymentTime}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-muted small">Payment Method:</div>
                                        <span class="badge bg-info">${paymentMethod.replace('_', ' ').toUpperCase()}</span>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small">Received By:</div>
                                        <strong><i class="fas fa-user me-1"></i>${receiverName}</strong>
                                        <div class="text-muted small">${receiverRole}</div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${payment._id}', '${orderId}')" title="Delete Payment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                ${payment.notes ? `
                                <div class="mt-2 text-muted small">
                                    <i class="fas fa-sticky-note me-1"></i><strong>Notes:</strong> ${payment.notes}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    const totalReceived = data.data.reduce((sum, p) => sum + p.amount, 0);
                    
                    historyDiv.innerHTML = `
                        <div class="mt-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted"><strong><i class="fas fa-history me-1"></i>Payment History (${data.data.length} payments):</strong></small>
                                <small class="text-muted">Total: <strong style="color: #10b981;">₹${totalReceived.toLocaleString()}</strong></small>
                            </div>
                            ${paymentsHTML}
                        </div>
                    `;
                } else {
                    historyDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>No payment history yet</small>';
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                document.getElementById(`payment_history_${orderId}`).innerHTML = 
                    '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading payment history</small>';
            }
        }
        
        // Delete payment record
        async function deletePayment(paymentId, orderId) {
            if (!confirm('Are you sure you want to delete this payment record? This will update the order payment totals.')) {
                return;
            }
            
            try {
                const response = await fetch(`https://manageroffice.onrender.com/api/payments/${paymentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Payment deleted successfully', 'success');
                    // Reload payment history
                    loadPaymentHistory(orderId);
                    // Refresh clients list
                    setTimeout(() => {
                        loadClients();
                    }, 1000);
                } else {
                    showAlert(`Error: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                showAlert('Network error while deleting payment', 'danger');
            }
        }
        
        // Add payment record
        async function addPaymentRecord(orderId, clientId, totalAmount) {
            const amount = parseFloat(document.getElementById(`payment_amount_${orderId}`).value) || 0;
            const paymentDate = document.getElementById(`payment_date_${orderId}`).value;
            const paymentMethod = document.getElementById(`payment_method_${orderId}`).value;
            const receivedBy = document.getElementById(`payment_receiver_${orderId}`).value;
            const notes = document.getElementById(`payment_notes_${orderId}`).value.trim();
            
            // Validation
            if (amount <= 0) {
                showAlert('Please enter a valid payment amount', 'warning');
                return;
            }
            
            if (!paymentDate) {
                showAlert('Please select payment date', 'warning');
                return;
            }
            
            if (!receivedBy) {
                showAlert('Please select who received the payment', 'warning');
                return;
            }
            
            try {
                const userData = JSON.parse(localStorage.getItem('user'));
                
                const paymentData = {
                    orderId: orderId,
                    clientId: clientId,
                    amount: amount,
                    paymentDate: paymentDate,
                    paymentMethod: paymentMethod,
                    receivedBy: receivedBy,
                    notes: notes,
                    shopName: userData.shopName
                };
                
                const response = await fetch('https://manageroffice.onrender.com/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Payment recorded successfully!', 'success');
                    
                    // Clear form
                    document.getElementById(`payment_amount_${orderId}`).value = '';
                    document.getElementById(`payment_date_${orderId}`).value = new Date().toISOString().split('T')[0];
                    document.getElementById(`payment_notes_${orderId}`).value = '';
                    
                    // Reload payment history
                    loadPaymentHistory(orderId);
                    
                    // Refresh clients list
                    setTimeout(() => {
                        loadClients();
                    }, 1000);
                } else {
                    showAlert(`Error: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error adding payment record:', error);
                showAlert('Network error while adding payment', 'danger');
            }
        }
        
        // Generate receipt
        async function generateReceipt(orderId, clientName) {
            try {
                const userData = JSON.parse(localStorage.getItem('user'));
                const params = new URLSearchParams({
                    shopName: userData.shopName,
                    userRole: 'owner',
                    userId: userData._id || userData.id
                });
                
                const response = await fetch(`https://manageroffice.onrender.com/api/orders?${params}`);
                const data = await response.json();
                
                const order = data.data.find(o => o._id === orderId);
                if (!order) {
                    showAlert('Order not found', 'danger');
                    return;
                }
                
                // Generate receipt HTML
                const receiptHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Receipt - ${order.orderName}</title>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                            
                            body { 
                                font-family: 'Inter', Arial, sans-serif; 
                                padding: 40px; 
                                max-width: 800px; 
                                margin: 0 auto; 
                                background: white;
                                color: #000;
                            }
                            
                            .header { 
                                text-align: center; 
                                border-bottom: 3px solid #000;
                                padding-bottom: 25px;
                                margin-bottom: 30px;
                            }
                            
                            .header h1 { 
                                margin: 0 0 10px 0; 
                                font-size: 2rem;
                                font-weight: 700;
                                text-transform: uppercase;
                                letter-spacing: 3px;
                                color: #000;
                            }
                            
                            .header .subtitle {
                                font-size: 0.9rem;
                                color: #666;
                                text-transform: uppercase;
                                letter-spacing: 2px;
                                font-weight: 500;
                            }
                            
                            .receipt-number {
                                text-align: right;
                                margin-bottom: 20px;
                                font-size: 0.9rem;
                                color: #666;
                            }
                            
                            .info { 
                                margin-bottom: 30px;
                                border: 1px solid #ddd;
                                padding: 20px;
                            }
                            
                            .info-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 10px;
                                padding: 5px 0;
                                border-bottom: 1px solid #f0f0f0;
                            }
                            
                            .info-row:last-child {
                                border-bottom: none;
                            }
                            
                            .info-row strong {
                                color: #000;
                                font-weight: 600;
                                min-width: 150px;
                            }
                            
                            .info-row span {
                                color: #333;
                            }
                            
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 30px 0;
                                border: 1px solid #000;
                            }
                            
                            th, td { 
                                padding: 12px 15px; 
                                text-align: left; 
                                border-bottom: 1px solid #ddd; 
                            }
                            
                            th { 
                                background: #000;
                                color: white;
                                font-weight: 600;
                                text-transform: uppercase;
                                font-size: 0.85rem;
                                letter-spacing: 1px;
                            }
                            
                            tbody tr:last-child td {
                                border-bottom: none;
                            }
                            
                            .text-right { text-align: right; }
                            
                            .total-section { 
                                margin-top: 30px; 
                                border-top: 2px solid #000; 
                                padding-top: 20px;
                                padding: 20px;
                                background: #f9f9f9;
                            }
                            
                            .total-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 10px; 
                                font-size: 1rem;
                                padding: 5px 0;
                            }
                            
                            .total-row.grand { 
                                font-size: 1.3rem; 
                                font-weight: 700; 
                                color: #000;
                                border-top: 2px solid #000;
                                padding-top: 15px;
                                margin-top: 15px;
                            }
                            
                            .footer { 
                                margin-top: 50px; 
                                text-align: center; 
                                color: #666; 
                                font-size: 0.85rem;
                                padding-top: 20px;
                                border-top: 1px solid #ddd;
                            }
                            
                            .footer p {
                                margin: 5px 0;
                            }
                            
                            .signature-section {
                                margin-top: 60px;
                                display: flex;
                                justify-content: space-between;
                            }
                            
                            .signature-box {
                                width: 45%;
                                text-align: center;
                            }
                            
                            .signature-line {
                                border-top: 1px solid #000;
                                margin-top: 50px;
                                padding-top: 10px;
                                font-size: 0.9rem;
                                color: #666;
                            }
                            
                            @media print {
                                body { 
                                    padding: 20px;
                                }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>${userData.shopName || 'Business Manager'}</h1>
                            <div class="subtitle">Payment Receipt</div>
                        </div>
                        
                        <div class="receipt-number">
                            <strong>Receipt No:</strong> ${order._id.slice(-8).toUpperCase()} | <strong>Date:</strong> ${new Date().toLocaleDateString()}
                        </div>
                        
                        <div class="info">
                            <div class="info-row">
                                <strong>Receipt Date:</strong>
                                <span>${new Date().toLocaleDateString()}</span>
                            </div>
                            <div class="info-row">
                                <strong>Client Name:</strong>
                                <span>${clientName}</span>
                            </div>
                            <div class="info-row">
                                <strong>Order Name:</strong>
                                <span>${order.orderName || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <strong>Venue:</strong>
                                <span>${order.venuePlace || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <strong>Order Date:</strong>
                                <span>${new Date(order.orderDate || order.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-right">Quantity/Size</th>
                                    <th class="text-right">Unit Price</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.products.map(product => {
                                    const quantityDisplay = product.sizeInfo || product.quantity;
                                    const lineTotal = product.price * product.quantity;
                                    return `
                                        <tr>
                                            <td>${product.name}</td>
                                            <td class="text-right">${quantityDisplay}</td>
                                            <td class="text-right">₹${product.price.toLocaleString()}</td>
                                            <td class="text-right">₹${lineTotal.toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <div class="total-section">
                            <div class="total-row">
                                <span>Total Amount:</span>
                                <span>₹${order.totalAmount.toLocaleString()}</span>
                            </div>
                            <div class="total-row" style="color: #10b981;">
                                <span>Amount Received:</span>
                                <span>₹${order.receivedPayment.toLocaleString()}</span>
                            </div>
                            <div class="total-row grand" style="color: ${order.remainingPayment > 0 ? '#ef4444' : '#10b981'};">
                                <span>Balance Due:</span>
                                <span>₹${order.remainingPayment.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        ${order.description ? `
                        <div style="margin-top: 20px;">
                            <strong>Notes:</strong>
                            <p>${order.description}</p>
                        </div>
                        ` : ''}
                        
                        <div class="signature-section">
                            <div class="signature-box">
                                <div class="signature-line">Authorized Signature</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">Client Signature</div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p><strong>Thank you for your business</strong></p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">This is a computer-generated receipt</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Print Receipt
                            </button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                                Close
                            </button>
                        </div>
                    </body>
                    </html>
                `;
                
                // Open receipt in new window
                const receiptWindow = window.open('', '_blank', 'width=800,height=600');
                receiptWindow.document.write(receiptHTML);
                receiptWindow.document.close();
                
            } catch (error) {
                console.error('Error generating receipt:', error);
                showAlert('Error generating receipt', 'danger');
            }
        }
        
        // Save client payment (old function - kept for compatibility)
        async function saveClientPayment(clientId, totalDue) {
            const modalHTML = `
                <div class="modal fade" id="editPaymentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>Update Payment - ${clientName}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="alert alert-info">
                                        <strong>Total Amount:</strong> ₹${totalDue.toLocaleString()}<br>
                                        <strong>Currently Received:</strong> ₹${currentReceived.toLocaleString()}<br>
                                        <strong>Pending:</strong> ₹${(totalDue - currentReceived).toLocaleString()}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Total Amount Received *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" id="receivedPaymentAmount" 
                                               value="${currentReceived}" min="0" max="${totalDue}" step="0.01">
                                    </div>
                                    <small class="text-muted">Enter the total amount received from this client</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Payment Notes (Optional)</label>
                                    <textarea class="form-control" id="paymentNotes" rows="2" 
                                              placeholder="Add notes about this payment..."></textarea>
                                </div>
                                
                                <div id="paymentUpdateResult"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveClientPayment('${clientId}', ${totalDue})">
                                    <i class="fas fa-save me-1"></i>Save Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('editPaymentModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
            modal.show();
        }
        
        // Save client payment
        async function saveClientPayment(clientId, totalDue) {
            const receivedAmount = parseFloat(document.getElementById('receivedPaymentAmount').value) || 0;
            const notes = document.getElementById('paymentNotes').value.trim();
            const resultDiv = document.getElementById('paymentUpdateResult');
            
            // Validation
            if (receivedAmount < 0) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Amount cannot be negative</div>';
                return;
            }
            
            if (receivedAmount > totalDue) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Received amount cannot exceed total amount</div>';
                return;
            }
            
            try {
                const response = await fetch(`https://manageroffice.onrender.com/api/clients/${clientId}/payment`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receivedAmount: receivedAmount,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Payment updated successfully!</div>';
                    
                    // Close modal and refresh after 1 second
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentModal'));
                        modal.hide();
                        loadClients();
                        showAlert('Payment information updated successfully', 'success');
                    }, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Network error while updating payment</div>';
            }
        }

    </script>
    
    <!-- Hamburger Menu JavaScript -->
    <script>
        // Hamburger menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerBtn = document.getElementById('hamburgerMenu');
            const sidebar = document.querySelector('.sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburgerIcon = document.getElementById('hamburgerIcon');
            
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                
                // Toggle hamburger icon
                if (sidebar.classList.contains('active')) {
                    hamburgerIcon.className = 'fas fa-times';
                } else {
                    hamburgerIcon.className = 'fas fa-bars';
                }
            }
            
            // Toggle sidebar when hamburger button is clicked
            hamburgerBtn.addEventListener('click', toggleSidebar);
            
            // Close sidebar when overlay is clicked
            mobileOverlay.addEventListener('click', toggleSidebar);
            
            // Close sidebar when a nav link is clicked (mobile)
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    mobileOverlay.classList.remove('active');
                    hamburgerIcon.className = 'fas fa-bars';
                }
            });
        });
    </script>
</body>
</html>
                
               